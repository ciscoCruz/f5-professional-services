---
- name: Migrate Application Services to a new BIGIP
  hosts: iq
  connection: local
  gather_facts: false
  vars:
    timeout: 120
  tasks:

    - name: Get authentication token
      uri:
        url: "https://{{ provider.server }}:{{ provider.server_port }}/mgmt/shared/authn/login"
        method: POST
        timeout: "{{ timeout }}"
        validate_certs: "{{ provider.validate_certs }}"
        body:
          username: "{{ provider.user }}"
          password: "{{ provider.password }}"
          loginProviderName: "{{ provider.auth_provider | default('tmos') }}"
        body_format: json
      register: authtoken

    - name: Set the token fact if authentication succeeded
      set_fact:
          f5_auth_token: "{{ authtoken.json.token.token }}"
      when: authtoken is success
    
    - name: Test authentication
      uri:
        url: "https://{{ provider.server }}:{{ provider.server_port }}/mgmt/shared/echo"
        timeout: "{{ timeout }}"
        validate_certs: "{{ provider.validate_certs }}"
        headers:
          X-F5-Auth-Token: "{{ f5_auth_token }}"
      register: status
    
    - name: Get device provisioning type
      uri:
        url: "https://{{ provider.server }}:{{ provider.server_port }}/mgmt/cm/system/provisioning"
        timeout: "{{ timeout }}"
        validate_certs: "{{ provider.validate_certs }}"
        headers:
          X-F5-Auth-Token: "{{ f5_auth_token }}"
      register: rprov

    - name: Fail if you're running the role against a DCD device
      fail:
        msg: "This role should be run against a CM device, but you appear to be running it against a DCD device"
      when: rprov.json.systemPersonality == 'logging_node'

    - name: Check if system is setup
      uri:
        url: "https://{{ provider.server }}:{{ provider.server_port }}/mgmt/shared/system/setup"
        timeout: "{{ timeout }}"
        validate_certs: "{{ provider.validate_certs }}"
        headers:
          X-F5-Auth-Token: "{{ f5_auth_token }}"
      register: setupchk

    - name: Stop if the system is not setup
      fail:
        msg: "The CM device has not been setup. Please onboard the DCD device first."
      when: setupchk.json.isSystemSetup is not defined or not setupchk.json.isSystemSetup|bool

    - name: Get Config set for Application Service
      uri:
        url: https://{{ provider.server }}:{{ provider.server_port }}/mgmt/cm/global/tenants
        method: GET
        timeout: "{{ timeout }}"
        validate_certs: "{{ provider.validate_certs }}"
        headers:
          X-F5-Auth-Token: "{{ f5_auth_token }}"
        status_code: 200, 202
      register: json_tenants

    - name: Debug the raw JSON response
      debug:
        var: json_tenants.json

    - name: Saving tenant name in a list
      set_fact:
        tenant_names: "{{ json_tenants.json | json_query('items[].name') | list }}" 

    - name: Debug tenant names in the loop
      debug:
        msg: "Processing tenant: {{ tenant_names }}"

    - name : Loop tenant names to migrate applications
      tags:
        - debugiq
      loop: "{{tenant_names}}"
      loop_control:
        loop_var: iqtenant
      vars:
        iquery: "items[?name=='{{ iqtenant }}'].body.target.address"
        iquery2: "items[?name=='{{ iqtenant }}'].selfLink"
        target_address: "{{ json_tenants.json | json_query(iquery) | first | default('undefined') }}"
        cs_selfLink: "{{ json_tenants.json | json_query(iquery2) | first | default('undefined') }}"
      include_tasks:
        ntarget.yaml